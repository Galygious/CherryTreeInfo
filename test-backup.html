<!DOCTYPE html>
<html>
<head>
    <title>Items Database</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        th { cursor: pointer; }
        .sort-asc::after { content: " ↑"; }
        .sort-desc::after { content: " ↓"; }
        .table-responsive { margin-top: 0.5rem; }
        th:hover { background-color: #f3f4f6; }
        .section {
            margin-bottom: 0.5rem;
        }
        .section-button {
            width: 100%;
            text-align: left;
            padding: 0.75rem 1rem;
            background-color: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .section-button:hover {
            background-color: #e5e7eb;
        }
        .section-button::after {
            content: " ▼";
            float: right;
        }
        .section-button.collapsed::after {
            content: " ▶";
        }
        .section-content {
            display: none;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-top: none;
            border-bottom-left-radius: 0.375rem;
            border-bottom-right-radius: 0.375rem;
            margin-top: -0.5rem;
        }
        .section-content.expanded {
            display: block;
        }
    </style>
    <script src="items.js"></script>
    <script src="archery.js"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-6xl mx-auto">
        <div class="bg-white rounded-lg shadow p-6">
            <h1 class="text-2xl font-bold mb-4">Equipment Database</h1>
            <div id="sections"></div>
        </div>
    </div>

    <script>
        // Table configurations
        const TABLE_CONFIGS = {
            // Default configuration for most equipment types
            default: {
                columns: [
                    {
                        header: 'Item',
                        width: '25%',
                        render: (item) => `
                            <span class="font-medium">
                                ${item.name}
                                ${item.rarity !== 'Common' ? 
                                    `<span class="ml-2 text-sm text-gray-500">(${item.rarity})</span>` 
                                    : ''}
                            </span>
                        `
                    },
                    {
                        header: 'Attack',
                        width: '8%',
                        align: 'center',
                        field: 'attackBonus'
                    },
                    {
                        header: 'Strength',
                        width: '8%',
                        align: 'center',
                        field: 'strengthBonus'
                    },
                    {
                        header: 'Defence',
                        width: '8%',
                        align: 'center',
                        field: 'defenceBonus'
                    },
                    {
                        header: 'Health',
                        width: '8%',
                        align: 'center',
                        field: 'healthBonus'
                    },
                    {
                        header: 'Details',
                        width: '33%',
                        render: (item) => `
                            <div>
                                ${item.description}
                                ${parseInt(item.value) > 0 ? 
                                    `<div class="text-sm text-gray-500">
                                        Value: ${formatNumber(parseInt(item.value))}
                                    </div>` 
                                    : ''}
                            </div>
                        `
                    }
                ]
            },
            // Configuration for bows
            bow: {
                columns: [
                    {
                        header: 'Bow',
                        width: '20%',
                        field: 'name'
                    },
                    {
                        header: 'Speed',
                        width: '10%',
                        align: 'center',
                        field: 'speed'
                    },
                    {
                        header: 'Damage',
                        width: '10%',
                        align: 'center',
                        field: 'damage'
                    },
                    {
                        header: 'Accuracy',
                        width: '10%',
                        align: 'center',
                        field: 'accuracy',
                        format: (value) => `${value}%`
                    },
                    {
                        header: 'Crit %',
                        width: '10%',
                        align: 'center',
                        field: 'critChance',
                        format: (value) => `${value}%`
                    }
                ]
            },
            // Configuration for arrows
            arrow: {
                columns: [
                    {
                        header: 'Arrow',
                        width: '50%',
                        field: 'name'
                    },
                    {
                        header: 'Damage',
                        width: '50%',
                        align: 'center',
                        field: 'damage'
                    }
                ]
            }
        };

        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        class TableGenerator {
            constructor() {
                this.sortStates = {};
            }

            generateTable(type, typeItems) {
                const config = TABLE_CONFIGS[type] || TABLE_CONFIGS.default;
                const sortState = this.sortStates[type] || { column: -1, direction: '' };

                const table = document.createElement('div');
                table.className = 'table-responsive';
                table.innerHTML = `
                    <table class="w-full border-collapse" id="${type.toLowerCase()}-table">
                        <thead>
                            <tr class="bg-gray-50">
                                ${this.generateHeaders(config, type, sortState)}
                            </tr>
                        </thead>
                        <tbody>
                            ${this.generateRows(config, typeItems, sortState)}
                        </tbody>
                    </table>
                `;

                // Add click handlers for sorting
                const headers = table.querySelectorAll('th');
                headers.forEach((header, index) => {
                    header.addEventListener('click', () => {
                        this.handleSort(type, index, typeItems, config);
                        // Re-render the table with new sort state
                        table.querySelector('tbody').innerHTML = 
                            this.generateRows(config, typeItems, this.sortStates[type]);
                        // Update sort indicators
                        headers.forEach((h, i) => {
                            h.innerHTML = this.generateColumnHeader(config.columns[i], i, this.sortStates[type]);
                        });
                    });
                });

                return table;
            }

            generateHeaders(config, type, sortState) {
                return config.columns.map((column, index) => `
                    <th class="p-3 text-left border cursor-pointer" 
                        style="width: ${column.width}">
                        ${this.generateColumnHeader(column, index, sortState)}
                    </th>
                `).join('');
            }

            generateColumnHeader(column, index, sortState) {
                return `
                    ${column.header}
                    ${sortState.column === index ? 
                        (sortState.direction === 'asc' ? ' ↑' : ' ↓') 
                        : ''}
                `;
            }

            generateRows(config, items, sortState) {
                const sortedItems = this.getSortedItems(items, config, sortState);
                
                return sortedItems.map(item => `
                    <tr class="hover:bg-gray-50">
                        ${config.columns.map(column => `
                            <td class="p-3 border ${column.align === 'center' ? 'text-center' : ''}">
                                ${this.generateCell(column, item)}
                            </td>
                        `).join('')}
                    </tr>
                `).join('');
            }

            generateCell(column, item) {
                if (column.render) {
                    return column.render(item);
                }
                if (column.field) {
                    const value = item[column.field];
                    if (column.format) {
                        return column.format(value);
                    }
                    return formatNumber(parseInt(value) || 0);
                }
                return item.name;
            }

            getSortedItems(items, config, sortState) {
                if (sortState.column === -1) return items;

                const column = config.columns[sortState.column];
                const sorted = [...items].sort((a, b) => {
                    let aValue = column.field ? a[column.field] : a.name;
                    let bValue = column.field ? b[column.field] : b.name;

                    // Convert to lowercase for string comparison
                    if (typeof aValue === 'string') aValue = aValue.toLowerCase();
                    if (typeof bValue === 'string') bValue = bValue.toLowerCase();

                    // Handle null/undefined values
                    aValue = aValue ?? 0;
                    bValue = bValue ?? 0;

                    if (aValue < bValue) return sortState.direction === 'asc' ? -1 : 1;
                    if (aValue > bValue) return sortState.direction === 'asc' ? 1 : -1;
                    return 0;
                });

                return sorted;
            }

            handleSort(type, columnIndex, items, config) {
                if (!this.sortStates[type]) {
                    this.sortStates[type] = { column: -1, direction: '' };
                }

                const currentState = this.sortStates[type];

                if (currentState.column === columnIndex) {
                    if (currentState.direction === 'desc') {
                        currentState.direction = 'asc';
                    } else if (currentState.direction === 'asc') {
                        currentState.column = -1;
                        currentState.direction = '';
                    }
                } else {
                    currentState.column = columnIndex;
                    currentState.direction = 'desc';
                }
            }
        }

        // Store original items
        const originalItems = [...items];
        const tableGen = new TableGenerator();

        function toggleSection(type) {
            const content = document.getElementById(`section-${type.toLowerCase()}-content`);
            const button = document.querySelector(`[data-section="${type}"]`);
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                button.classList.add('collapsed');
            } else {
                content.classList.add('expanded');
                button.classList.remove('collapsed');
            }
        }

        String.prototype.toTitleCase = function() {
            return this.replace(/\w\S*/g, function(txt) {
                return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
            });
        };

        function populateTables() {
            // Group items by type
            const groupedItems = items.reduce((acc, item) => {
                const mainType = item.type.includes('Equipment-') ? 
                    item.type.split('Equipment-')[1] : item.type;
                
                if (!acc[mainType]) {
                    acc[mainType] = [];
                }
                acc[mainType].push({...item});
                return acc;
            }, {});

            // Add bow and arrow items
            groupedItems['bow'] = bows;
            groupedItems['arrow'] = arrows;

            // Create sections with buttons and tables
            const container = document.getElementById('sections');
            container.innerHTML = '';

            // Sort and create sections
            Object.entries(groupedItems)
                .sort(([typeA], [typeB]) => typeA.localeCompare(typeB))
                .forEach(([type, typeItems]) => {
                    const section = document.createElement('div');
                    section.className = 'section';

                    const button = document.createElement('button');
                    button.className = 'section-button collapsed';
                    button.onclick = () => toggleSection(type);
                    button.setAttribute('data-section', type);
                    button.textContent = type.toLowerCase() === 'null' ? 'Miscellaneous' : type.toTitleCase();

                    const content = document.createElement('div');
                    content.id = `section-${type.toLowerCase()}-content`;
                    content.className = 'section-content';
                    
                    const table = tableGen.generateTable(type, typeItems);
                    content.appendChild(table);

                    section.appendChild(button);
                    section.appendChild(content);
                    container.appendChild(section);
                });
        }

        // Initialize tables
        populateTables();
    </script>
</body>
</html>