<!-- 
 File: index.html
-->

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Enemy Data with Expandable Drops, Asc/Dsc Sorting, Searching, and God-Exclusive Drops</title>
  <style>
    /* General Table Styles */
    body {
      font-family: 'Arial', sans-serif;
      background-color: #121212; /* Dark background */
      color: #FFFFFF; /* White text */
      margin: 0;
      padding: 0;
    }
    h1 {
      text-align: center;
      margin-top: 20px;
      color: #FFFFFF;
    }

    /* Search Input */
    #searchContainer {
      text-align: center;
      margin: 20px 0;
    }
    #searchInput {
      padding: 8px;
      font-size: 14px;
      border-radius: 4px;
      border: 1px solid #333;
      background-color: #1A1A1A;
      color: #FFFFFF;
      width: 250px;
    }
    #searchInput::placeholder {
      color: #888;
    }

    /* Main Table Styling */
    table {
      width: 95%;
      margin: 20px auto;
      border-collapse: collapse;
      background-color: #1A1A1A; 
      color: #FFFFFF;
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border: 1px solid #272727;
      vertical-align: middle;
    }
    thead th {
      background-color: #2C2C2C;
      font-weight: bold;
      cursor: pointer; /* We'll sort on click */
    }
    tbody tr {
      border-bottom: 1px solid #272727;
    }
    tbody tr:last-child {
      border-bottom: none;
    }

    /* Subtable Rows */
    tr.subtable {
      display: none; /* Hide subtables by default */
      background-color: #1E1E1E;
    }
    tr.subtable td {
      padding: 0;
    }

    /* Drop Table Styling */
    .drop-table {
      width: 100%;
      border-collapse: collapse;
      background-color: #2C2C2C; 
      color: #FFFFFF;
      border-radius: 4px;
      margin-bottom: 20px;
    }
    .drop-table th, .drop-table td {
      padding: 8px;
      text-align: left;
      border: 1px solid #272727;
    }
    .drop-table th {
      background-color: #3A3A3A;
      font-weight: bold;
    }

    /* Interactive Elements */
    .clickable-row {
      cursor: pointer;
      background-color: #1A1A1A; 
    }
    .clickable-row:hover {
      background-color: #272727;
    }

    /* Footer Text */
    footer {
      text-align: center;
      padding: 10px;
      background-color: #1A1A1A;
      color: #A0A0A0;
      border-top: 2px solid #272727;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>Enemy Data with Expandable Drops & Correct Asc/Dsc Sorting</h1>
  <h1>God Drops Integration Example</h1>

  <div id="searchContainer">
    <input type="text" id="searchInput" placeholder="Search enemy name..." />
  </div>

  <!-- 
      We skip column #10 (Drops) in the main table because it's displayed in a subtable row.
      Final column mapping:
        0  => Enemy Name
        1  => Icon
        2  => Health
        3  => Attack
        4  => Strength
        5  => Defence
        6  => Attack Speed
        7  => Slayer Exp
        8  => Weakness
        9  => Slayer Level
        10 => Drops (subtable only)
        11 => Area
        12 => Scroll Drop %
        13 => Kills
  -->
  <table id="enemyTable">
    <thead>
      <tr>
        <th data-sort-col="0">Enemy Name</th>
        <th data-sort-col="1">Icon</th>
        <th data-sort-col="2">Health</th>
        <th data-sort-col="3">Attack</th>
        <th data-sort-col="4">Strength</th>
        <th data-sort-col="5">Defence</th>
        <th data-sort-col="6">Attack Speed</th>
        <th data-sort-col="7">Slayer Exp</th>
        <th data-sort-col="8">Weakness</th>
        <th data-sort-col="9">Slayer Lvl</th>
        <th data-sort-col="11">Area</th>
        <th data-sort-col="12">Scroll Drop %</th>
        <th data-sort-col="13">Kills</th>
      </tr>
    </thead>
    <tbody>
      <!-- Rows get dynamically populated -->
    </tbody>
  </table>

  <script>
    /*
      We’ll unify everything into one coherent script:
      1) CSV parse
      2) Table building (with subtable for normal drops)
      3) Additional subtable for God-exclusive drops
      4) Sorting (asc/dsc)
      5) Searching
    */

    // God data
    const allGods = [
      "Amaran", "Aurial", "Cognium", "Copina", 
      "Feroxi", "Kynosian", "Noctyra", "Opulina"
    ];
    const allGodDrops = [
      ["Shield of Amaran", "Ring of Life", "Necklace of Defence", "Necklace of Health", "Queens Armour Fragment", "Kings Armour Fragment", "Invincibility Potion", "Rock Skin Potion", "Dragon Platter", "Iridium Ore"],
      ["Scythe of Aurial", "Scythe of Demeter", "Restoration Fragment 2", "Magic Watering Can", "Farm Chest", "Farm Key", "Wine", "Eggplant", "Fruit Salad", "Lemon"],
      ["Sword of Cognium", "Ring of Speed", "Ring Fragments", "Sextant", "Steel Bar", "Cog", "Iron Ore"],
      ["Rod of Copina", "Knife of Copina", "Rabbits Foot", "Eagles Nest", "Book of Aroon", "Stone Tablet", "Ginkgo Log", "Shark", "Marlin", "Chestnut Log", "Large Fishing Net", "Rhodium Ore"],
      ["Shield of Feroxi", "Gloves of Feroxi", "Berserker Ring", "Extreme Power Stone", "Necklace of Strength", "Kings Weapon Fragment", "Queens Weapon Fragment", "Ultimate Power Potion", "Super Power Stone", "Tooth Necklace", "Super Power Potion", "Power Potion"],
      ["Quiver of Kynosian", "Kynosian Boots", "Kynosian Gloves", "Kynosian Arrows", "Elven Bow", "Elven Arrows", "Kings Bow", "Kings Arrows", "Queens Bow", "Queens Arrows", "Ginkgo Headless Arrows", "Ginkgo Arrow Shafts"],
      ["Mystic Staff", "Death Princess Rune", "Ancient Elven Book", "Ring of Death", "Book of Death", "Soul Gem", "Liquid Death Potion", "Dragon Skull", "Insta Kill Potion", "Big Dragon Bones", "Dragon Bones", "Bones"],
      ["Opulinas Robe Bottoms", "Gold Coin", "Gold Coin", "Golden Touch Potion", "Gold Coin", "Golden Scarab", "Pot of Gold", "Treasure Map", "Gold Coin", "Gold Bar", "Gold Feather", "Gold Ore"]
    ];
    const allGodDropAmounts = [
      ["1,1", "1,1", "1,1", "1,1", "4,5", "2,3", "1,3", "2,5", "15,25", "10,20"],
      ["1,1", "1,1", "1,1", "1,1", "2,3", "2,3", "15,20", "10,15", "15,20", "15,20"],
      ["1,1", "1,1", "1,2", "3,5", "15,20", "5,10", "20,30"],
      ["1,1", "1,1", "1,1", "2,3", "4,5", "4,5", "20,25", "40,50", "50,60", "25,40", "5,10", "15,25"],
      ["1,1", "1,1", "1,1", "1,2", "1,1", "2,3", "3,4", "2,5", "2,5", "3,5", "5,10", "10,15"],
      ["1,1", "1,1", "1,1", "2,5", "1,1", "5,10", "1,1", "15,20", "1,1", "20,30", "25,40", "40,60"],
      ["1,1", "1,1", "1,1", "1,1", "1,1", "1,1", "5,10", "5,10", "10,15", "15,20", "20,25", "30,40"],
      ["1,1", "100,100", "25,25", "2,5", "15,15", "5,10", "5,10", "5,10", "5,5", "15,20", "25,30", "30,40"]
    ];
    const allGodDropRates = [
      [1, 4, 14, 24, 144, 384, 984, 2984, 7984, 17984],
      [1, 3, 5, 13, 163, 313, 1313, 4313, 10313, 20313],
      [1, 4, 19, 519, 3019, 8019, 18019],
      [1, 2, 6, 106, 256, 406, 906, 1706, 4206, 8206, 14206, 24206],
      [1, 2, 5, 11, 17, 67, 187, 937, 1937, 3937, 8937, 18937],
      [1, 2, 3, 9, 24, 54, 204, 454, 954, 1704, 9204, 19204],
      [1, 3, 6, 11, 16, 22, 522, 1272, 2772, 5772, 10772, 20772],
      [1, 3, 7, 15, 31, 111, 411, 1011, 2011, 4511, 9511, 17511]
    ];

    // Main CSV data
    const csvData = `
Enemy Name,Enemy Icon,Enemy Health,Enemy Attack,Enemy Strength,Enemy Defence,Enemy Attack Speed,Enemy Slayer Exp,Enemy Weakness,Enemy Slayer Level,Enemy Drops,Enemy Area,Scroll Drop %,Kills
Chicken,R.drawable.enemy_chicken_01,10,1,1,1,Slow,11,Melee,1,"Bones,1,1,Always/Feathers,1,3,Always/Egg,1,1,Uncommon/Drumstick,1,1,Rare/Thread,1,1,Common/Birds Nest,1,1,Uncommon/Common Key,1,1,Rare/Chicken Knife,1,1,Secret Rare",Farm,0.0006%,155340
Aurial,R.drawable.enemy_aurial,4000000,60000,225000,36000,Fast,216060,None,130,"Gold Coin,5,10,Always",KingdomoftheGods,6.7522%,15
Amaran,R.drawable.enemy_amaran,7000000,70000,300000,67500,VeryFast,371885,None,1,"Gold Coin,5,10,Always",KingdomoftheGods,11.6217%,9
Feroxi,R.drawable.enemy_feroxi,6500000,90000,562500,63000,VeryFast,360785,None,130,"Gold Coin,5,10,Always",KingdomoftheGods,11.2748%,9
`.trim();

    let currentData = [];
    let sortDirections = {}; // track asc/dsc for each column

    document.addEventListener('DOMContentLoaded', () => {
      const { data } = parseCsv(csvData);
      currentData = data;
      initSorting();
      initSearch();
      populateTable(currentData);
    });

    /**
     * Parse CSV lines, ignoring quotes for the header, but properly parsing data.
     */
    function parseCsv(csvString) {
      const lines = csvString.split('\n');
      // lines[0] => CSV header row, not used directly for display
      const dataRows = lines.slice(1);

      const data = dataRows.map((row) => splitByCsvRules(row));
      return { data };
    }

    /**
     * Split each CSV line by commas, respecting quotes.
     */
    function splitByCsvRules(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current.trim());
          current = '';
        } else {
          current += char;
        }
      }
      result.push(current.trim());
      return result;
    }

    /**
     * Populate the table rows (with sub-rows for drops).
     */
    function populateTable(dataArray) {
      const tbody = document.querySelector('#enemyTable tbody');
      tbody.innerHTML = '';

      dataArray.forEach(row => {
        // CSV columns:
        //  0:  Enemy Name
        //  1:  Enemy Icon
        //  2:  Health
        //  3:  Attack
        //  4:  Strength
        //  5:  Defence
        //  6:  Attack Speed
        //  7:  Slayer Exp
        //  8:  Weakness
        //  9:  Slayer Level
        // 10:  Drops
        // 11:  Area
        // 12:  Scroll Drop %
        // 13:  Kills
        const [
          enemyName,
          enemyIcon,
          enemyHealth,
          enemyAttack,
          enemyStrength,
          enemyDefence,
          enemyAttackSpeed,
          enemySlayerExp,
          enemyWeakness,
          enemySlayerLevel,
          dropsString,   // not displayed in main row
          enemyArea,
          scrollChance,
          kills
        ] = row;

        // Create main row
        const mainRow = document.createElement('tr');
        mainRow.classList.add('clickable-row');
        mainRow.innerHTML = `
          <td>${enemyName}</td>
          <td><img src="drawable/${enemyIcon.replace('R.drawable.', '')}.png" alt="icon" width="64" height="64"/></td>
          <td>${enemyHealth}</td>
          <td>${enemyAttack}</td>
          <td>${enemyStrength}</td>
          <td>${enemyDefence}</td>
          <td>${enemyAttackSpeed}</td>
          <td>${enemySlayerExp}</td>
          <td>${enemyWeakness}</td>
          <td>${enemySlayerLevel}</td>
          <td>${enemyArea}</td>
          <td>${scrollChance}</td>
          <td>${kills}</td>
        `;

        // Create sub-row
        const subRow = document.createElement('tr');
        subRow.classList.add('subtable');
        const subRowCell = document.createElement('td');
        subRowCell.colSpan = 13; // total columns in main row

        // Build the "normal drops" table
        const dropTable = document.createElement('table');
        dropTable.className = 'drop-table';
        dropTable.innerHTML = `
          <thead>
            <tr>
              <th>Drop Name</th>
              <th>Min Qty</th>
              <th>Max Qty</th>
              <th>Drop Class</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;
        const dropTableBody = dropTable.querySelector('tbody');
        const dropsArray = parseDrops(dropsString);
        dropsArray.forEach(d => {
          // format: [dropName, minQty, maxQty, dropClass]
          const [dn, mn, mx, dc] = d;
          const rateLabel = getDropRateLabel(dc);
          const rowEl = document.createElement('tr');
          rowEl.innerHTML = `
            <td>${dn}</td>
            <td>${mn || 1}</td>
            <td>${mx || 1}</td>
            <td>${dc || 'Unknown'} (${rateLabel})</td>
          `;
          dropTableBody.appendChild(rowEl);
        });

        // Check if this enemy is a God => add a second table
        const godIndex = allGods.indexOf(enemyName);
        if (godIndex !== -1) {
          // build a "God-Exclusive" drop table
          const godTable = document.createElement('table');
          godTable.className = 'drop-table';
          godTable.innerHTML = `
            <thead>
              <tr>
                <th>God-Exclusive Drop</th>
                <th>Min Qty</th>
                <th>Max Qty</th>
                <th>Drop Rate (1 in X)</th>
              </tr>
            </thead>
            <tbody></tbody>
          `;
          const godBody = godTable.querySelector('tbody');
          const theseDrops = allGodDrops[godIndex];
          const theseAmounts = allGodDropAmounts[godIndex];
          const theseRates = allGodDropRates[godIndex];

          for (let i = 0; i < theseDrops.length; i++) {
            const [minQ, maxQ] = theseAmounts[i].split(',');
            const rowEl2 = document.createElement('tr');
            rowEl2.innerHTML = `
              <td>${theseDrops[i]}</td>
              <td>${minQ}</td>
              <td>${maxQ}</td>
              <td>${theseRates[i]}</td>
            `;
            godBody.appendChild(rowEl2);
          }

          // Insert this God table after the normal drop table
          dropTable.insertAdjacentElement('afterend', godTable);
        }

        // Append normal drop table into the subRow
        subRowCell.appendChild(dropTable);
        subRow.appendChild(subRowCell);

        // Toggle subtable
        mainRow.addEventListener('click', () => {
          subRow.style.display = (subRow.style.display === 'table-row') ? 'none' : 'table-row';
        });

        // Add both rows to the DOM
        tbody.appendChild(mainRow);
        tbody.appendChild(subRow);
      });
    }

    /**
     * Mini parser for the “Drops” cell => "name,minQty,maxQty,class" separated by '/', etc.
     */
    function parseDrops(dropsString) {
      let cleaned = dropsString.trim();
      if (cleaned.startsWith('"') && cleaned.endsWith('"')) {
        cleaned = cleaned.slice(1, -1);
      }
      if (!cleaned) return [];
      const dropRows = cleaned.split('/');
      return dropRows.map(row => row.split(',').map(x => x.trim()));
    }

    /**
     * Provide approximate labels for each standard drop class.
     */
    function getDropRateLabel(dropClass) {
      const map = {
        'Always': '1 in 1',
        'Common': '1 in 3.3',
        'Uncommon': '1 in 16.3',
        'Rare': '1 in 83.3',
        'Super Rare': '1 in 1,250',
        'Legendary': '1 in 5,000',
        'Mythical': '1 in 16,666.3',
        'Secret Rare': '1 in 16,666.3'
      };
      return map[dropClass] || 'Unknown';
    }

    /**
     * Sorting: toggles asc/dsc by column index.
     */
    function initSorting() {
      const thElems = document.querySelectorAll('#enemyTable thead th[data-sort-col]');
      thElems.forEach(th => {
        th.addEventListener('click', () => {
          const colIndex = parseInt(th.getAttribute('data-sort-col'), 10);
          // Toggle direction
          if (sortDirections[colIndex] === undefined) {
            sortDirections[colIndex] = true; // default ascending
          } else {
            sortDirections[colIndex] = !sortDirections[colIndex];
          }
          sortData(colIndex, sortDirections[colIndex]);
        });
      });
    }

    function sortData(colIndex, ascending) {
      // Numeric columns => parseFloat
      //  2,3,4,5,7,9,12,13
      const numericCols = [2, 3, 4, 5, 7, 9, 12, 13];

      currentData.sort((a, b) => {
        let A = a[colIndex];
        let B = b[colIndex];

        if (numericCols.includes(colIndex)) {
          if (colIndex === 12) {
            // Scroll drop => remove '%'
            A = parseFloat(A.replace('%', ''));
            B = parseFloat(B.replace('%', ''));
          } else {
            A = parseFloat(A);
            B = parseFloat(B);
          }
          return ascending ? (A - B) : (B - A);
        } else {
          // string compare
          const cmp = A.localeCompare(B);
          return ascending ? cmp : -cmp;
        }
      });

      populateTable(currentData);
    }

    /**
     * Searching by name (column 0).
     */
    function initSearch() {
      const input = document.getElementById('searchInput');
      input.addEventListener('input', () => {
        const val = input.value.toLowerCase();
        // Filter by enemyName => col 0
        const filtered = currentData.filter(row => row[0].toLowerCase().includes(val));
        populateTable(filtered);
      });
    }
  </script>

  <footer>
    <p>Expandable subtables for normal drops, plus God-exclusive drops if the enemy matches one of the <strong>allGods</strong>. Sorting (asc/dsc) and searching by name remain intact.</p>
  </footer>
</body>
</html>
