<!-- File: index.html -->
<!DOCTYPE html>
<html>
<head>
    <nav>
        <a href="index.html">Mobs</a>
        <a href="items.html">Items</a>
        <a href="calculator.html">Energy Calculator</a>
    </nav>
    <title>Equipment Database</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        th { cursor: pointer; }
        .sort-asc::after { content: " ↑"; }
        .sort-desc::after { content: " ↓"; }
        .table-responsive {
            margin-top: 0.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 1px;
            justify-content: flex-start;
            align-items: flex-start;
        }
        th:hover { background-color: #f3f4f6; }
        .section {
            margin-bottom: 0.5rem;
        }
        .section-button {
            width: 100%;
            text-align: left;
            padding: 0.75rem 1rem;
            background-color: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .section-button:hover {
            background-color: #e5e7eb;
        }
        .section-button::after {
            content: " ▼";
            float: right;
        }
        .section-button.collapsed::after {
            content: " ▶";
        }
        .section-content {
            display: none;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-top: none;
            border-bottom-left-radius: 0.375rem;
            border-bottom-right-radius: 0.375rem;
            margin-top: -0.5rem;
        }
        .section-content.expanded {
            display: block;
        }
        /* Changed from inline to inline-flex and added align-items to reduce extra spacing */
        .item-container {
            display: inline-flex;
            align-items: center;
            margin-right: 20px;
            width: 100%;
        }

        /* Enforce border-collapse and smaller padding/line-height to shrink row height */
        table.w-full.border-collapse {
            border-collapse: collapse;
        }
        table.w-full.border-collapse th,
        table.w-full.border-collapse td {
            padding: 0.5rem; /* Reduce padding from p-3 (which is ~12px) to ~8px */
            line-height: 1.2; /* Reduce line-height for tighter rows */
            vertical-align: middle; /* Vertically center the cell contents */
        }
        nav {
            background-color: #333;
            padding: 10px;
            text-align: center;
        }
        nav a {
            color: white;
            text-decoration: none;
            margin: 0 15px;
            font-size: 1.2em;
        }
        nav a:hover {
            text-decoration: underline;
        }
    </style>
    <script src="items.js"></script>
    <script src="archery.js"></script>
    <script src="mobs.js"></script>
    <script>
        console.log(monsters);
    </script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-6xl mx-auto">
        <div class="bg-white rounded-lg shadow p-6">
            <h1 class="text-2xl font-bold mb-4">Equipment Database</h1>
            <div id="sections"></div>
        </div>
    </div>

    <script>
        // Data Sources Mapping
        const DATA_SOURCES = {
            items: items,
            bows: bows,
            arrows: arrows,
            tableList: tableList,
        };

        // Utility Function to Format Numbers with Commas
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        // Helper function to parse potential string/number for sorting
        function parseForSorting(value) {
            const num = parseFloat(value);
            if (!isNaN(num)) {
                return num;
            }
            if (typeof value === 'string') {
                return value.toLowerCase();
            }
            return value || 0;
        }

        // Configuration-Driven Table Settings
        const TABLE_CONFIGS = {
            default: {
                dataSource: {
                    source: 'items',
                    filter: (item, type) => {
                        const itemType = item.type?.includes('Equipment-')
                            ? item.type.split('Equipment-')[1]
                            : item.type;
                        return (
                            itemType &&
                            itemType.toLowerCase() === type.toLowerCase() &&
                            !TABLE_CONFIGS[itemType.toLowerCase()]
                        );
                    }
                },
                columns: [
                    {
                        header: 'Item',
                        width: '25%',
                        source: 'items',
                        field: 'name',
                        render: (item) => `
                        <div class="item-container font-medium w-full">
                            <img src="drawable/${item.icon}.png" alt="${item.name}" class="w-12 h-12 mr-2">
                            <div align="center" class="text-center w-full">
                                ${item.name}
                                ${item.rarity !== 'Common' 
                                ? `<div class="ml-2 text-sm text-gray-500">(${item.rarity})</div>` 
                                : ''
                                }
                            </div>
                        </div>
                      `
                    },
                    {
                        header: 'Attack',
                        width: '8%',
                        align: 'center',
                        source: 'items',
                        field: 'attackBonus'
                    },
                    {
                        header: 'Strength',
                        width: '8%',
                        align: 'center',
                        source: 'items',
                        field: 'strengthBonus'
                    },
                    {
                        header: 'Defence',
                        width: '8%',
                        align: 'center',
                        source: 'items',
                        field: 'defenceBonus'
                    },
                    {
                        header: 'Health',
                        width: '8%',
                        align: 'center',
                        source: 'items',
                        field: 'healthBonus'
                    },
                    {
                        header: 'Details',
                        width: '33%',
                        source: 'items',
                        // Example of domSortSelector usage if you'd like to sort by "value" in the rendered HTML
                        domSortSelector: '.sortval',
                        render: (item) => {
                            // We'll embed the numeric value in a <span> with a data-sort-val attribute
                            const numericValue = parseInt(item.value) || 0;
                            return `
                                <div>
                                    ${
                                        item.description && item.description !== 'null' 
                                            ? `<span class="text-gray-300">
                                                ${item.description}
                                               </span>`
                                            : ''
                                    }
                                    ${
                                        numericValue > 0 
                                            ? `<div class="text-sm text-gray-500">
                                                   Value: 
                                                   <span 
                                                      class="sortval" 
                                                      data-sort-val="${numericValue}"
                                                   >
                                                      ${formatNumber(numericValue)}
                                                   </span>
                                               </div>` 
                                            : ''
                                    }
                                </div>
                            `;
                        }
                    }
                ]
            },
            weapon: {
                dataSource: {
                    source: 'items',
                    filter: (item) => {
                        if (item.type && item.type.toLowerCase().includes('equipment-weapon')) {
                            const isBow = bows.some(b => b.name === item.name);
                            return !isBow;
                        }
                        return false;
                    }
                },
                columns: [
                    {
                        header: 'Item',
                        width: '25%',
                        source: 'items',
                        field: 'name',
                        render: (item) => `
                        <div class="item-container font-medium w-full">
                            <img src="drawable/${item.icon}.png" alt="${item.name}" class="w-12 h-12 mr-2">
                            <div align="center" class="text-center w-full">
                                ${item.name}
                                ${item.rarity !== 'Common' 
                                ? `<div class="ml-2 text-sm text-gray-500">(${item.rarity})</div>` 
                                : ''
                                }
                            </div>
                        </div>
                      `
                    },
                    {
                        header: 'Attack',
                        width: '8%',
                        align: 'center',
                        source: 'items',
                        field: 'attackBonus'
                    },
                    {
                        header: 'Strength',
                        width: '8%',
                        align: 'center',
                        source: 'items',
                        field: 'strengthBonus'
                    },
                    {
                        header: 'Defence',
                        width: '8%',
                        align: 'center',
                        source: 'items',
                        field: 'defenceBonus'
                    },
                    {
                        header: 'Health',
                        width: '8%',
                        align: 'center',
                        source: 'items',
                        field: 'healthBonus'
                    },
                    {
                        header: 'Details',
                        width: '33%',
                        source: 'items',
                        domSortSelector: '.sortval',
                        render: (item) => {
                            const numericValue = parseInt(item.value) || 0;
                            return `
                                ${
                                    item.description && item.description !== 'null' 
                                        ? `<span class="text-gray-300">
                                            ${item.description}
                                           </span>`
                                        : ''
                                }
                                <div>
                                    ${
                                        numericValue > 0 
                                            ? `<div class="text-sm text-gray-500">
                                                   Value: 
                                                   <span
                                                     class="sortval" 
                                                     data-sort-val="${numericValue}"
                                                   >
                                                     ${formatNumber(numericValue)}
                                                   </span>
                                               </div>` 
                                            : ''
                                    }
                                </div>
                            `;
                        }
                    }
                ]
            },
            bow: {
                dataSource: {
                    source: 'bows',
                    filter: () => true
                },
                columns: [
                    {
                        header: 'Bow',
                        width: '20%',
                        source: 'items',
                        render: (item) => `
                        <div class="item-container font-medium w-full">
                            <img src="drawable/${item.icon}.png" alt="${item.name}" class="w-12 h-12 mr-2">
                            <div align="center" class="text-center w-full">
                                ${item.name}
                                ${item.rarity !== 'Common' 
                                ? `<div class="ml-2 text-sm text-gray-500">(${item.rarity})</div>` 
                                : ''
                                }
                            </div>
                        </div>
                      `
                    },
                    {
                        header: 'Speed',
                        width: '20%',
                        align: 'center',
                        source: 'bows',
                        field: 'speed'
                    }
                ]
            },
            arrows: {
                dataSource: {
                    source: 'arrows',
                    filter: () => true
                },
                columns: [
                    {
                        header: 'Arrows',
                        width: '33%',
                        source: 'items',
                        render: (item) => `
                        <div class="item-container font-medium w-full">
                            <img src="drawable/${item.icon}.png" alt="${item.name}" class="w-12 h-12 mr-2">
                            <div align="center" class="text-center w-full">
                                ${item.name}
                                ${item.rarity !== 'Common' 
                                ? `<div class="ml-2 text-sm text-gray-500">(${item.rarity})</div>` 
                                : ''
                                }
                            </div>
                        </div>
                      `
                    },
                    {
                        header: 'Damage',
                        width: '33%',
                        align: 'center',
                        source: 'arrows',
                        field: 'damage'
                    },
                    {
                        header: 'Details',
                        width: '33%',
                        source: 'items',
                        domSortSelector: '.sortval',
                        render: (item) => {
                            const numericValue = parseInt(item.value) || 0;
                            return `
                                ${
                                    item.description && item.description !== 'null' 
                                        ? `<span class="text-gray-300">
                                               ${item.description}
                                           </span>`
                                        : ''
                                }
                                <div>
                                    ${
                                        numericValue > 0 
                                            ? `<div class="text-sm text-gray-500">
                                                   Value: 
                                                   <span
                                                     class="sortval" 
                                                     data-sort-val="${numericValue}"
                                                   >
                                                     ${formatNumber(numericValue)}
                                                   </span>
                                               </div>` 
                                            : ''
                                    }
                                </div>
                            `;
                        }
                    }
                ]
            }
        };

        class TableGenerator {
            constructor() {
                this.sortStates = {};
            }

            getFilteredData(config, type) {
                const ds = config.dataSource;
                if (!ds || !DATA_SOURCES[ds.source]) return [];
                const baseItems = DATA_SOURCES[ds.source];
                if (typeof ds.filter === 'function') {
                    return baseItems.filter(item => ds.filter(item, type));
                }
                return baseItems;
            }

            getSortedData(data, config, sortState, tableElement) {
                if (sortState.column === -1) return data;
                const columnDef = config.columns[sortState.column];
                if (!columnDef) return data;

                // If standard field-based sort:
                if (columnDef.field && !columnDef.domSortSelector) {
                    return [...data].sort((a, b) => {
                        const aValue = parseForSorting(a[columnDef.field]);
                        const bValue = parseForSorting(b[columnDef.field]);
                        if (aValue < bValue) return sortState.direction === 'asc' ? -1 : 1;
                        if (aValue > bValue) return sortState.direction === 'asc' ? 1 : -1;
                        return 0;
                    });
                }

                // If DOM-based:
                if (columnDef.domSortSelector && tableElement) {
                    const rows = Array.from(tableElement.querySelectorAll('tbody tr'));
                    const combined = rows.map(row => {
                        const cell = row.querySelectorAll('td')[sortState.column];
                        if (!cell) {
                            return { row, sortValue: '' };
                        }
                        let sortValue = '';
                        const domEl = cell.querySelector(columnDef.domSortSelector);
                        if (domEl) {
                            const dataVal = domEl.getAttribute('data-sort-val');
                            sortValue = dataVal ? parseForSorting(dataVal) : parseForSorting(domEl.textContent);
                        }
                        return { row, sortValue };
                    });

                    combined.sort((a, b) => {
                        if (a.sortValue < b.sortValue) return sortState.direction === 'asc' ? -1 : 1;
                        if (a.sortValue > b.sortValue) return sortState.direction === 'asc' ? 1 : -1;
                        return 0;
                    });

                    const tbody = tableElement.querySelector('tbody');
                    combined.forEach(item => tbody.appendChild(item.row));
                    return combined.map(item => data[rows.indexOf(item.row)]);
                }

                return data;
            }

            generateTable(type) {
                const lowerType = type.toLowerCase();
                const config = TABLE_CONFIGS[lowerType] || TABLE_CONFIGS.default;
                const sortState = this.sortStates[lowerType] || { column: -1, direction: '' };
                this.sortStates[lowerType] = sortState;

                const filteredData = this.getFilteredData(config, lowerType);

                const tableWrapper = document.createElement('div');
                tableWrapper.className = 'table-responsive';
                const tableId = `${lowerType}-table`;
                tableWrapper.innerHTML = `
                    <table class="w-full border-collapse" id="${tableId}">
                        <thead>
                            <tr class="bg-gray-50">
                                ${this.generateHeaders(config, sortState)}
                            </tr>
                        </thead>
                        <tbody>
                            ${this.generateRows(config, filteredData, sortState)}
                        </tbody>
                    </table>
                `;

                this.attachSortHandlers(tableWrapper, lowerType, config);
                return tableWrapper;
            }

            generateHeaders(config, sortState) {
                return config.columns.map((column, index) => {
                    let sortIndicator = '';
                    if (sortState.column === index) {
                        sortIndicator = sortState.direction === 'asc' ? ' ↑' : ' ↓';
                    }
                    return `
                        <th class="p-3 text-left border cursor-pointer" style="width: ${column.width}">
                            ${column.header}${sortIndicator}
                        </th>
                    `;
                }).join('');
            }

            generateRows(config, data, sortState) {
                // At initial build, we pass null for tableElement
                const sorted = this.getSortedData(data, config, sortState, null);
                return sorted.map(item => {
                    const rowCells = config.columns.map(col => {
                        return this.generateCell(col, item, config);
                    });
                    return `<tr class="hover:bg-gray-50">${rowCells.join('')}</tr>`;
                }).join('');
            }

            generateCell(column, item, config) {
                // If the column's "source" is different from the table-level dataSource,
                // we attempt to find a matching object by name in that other source
                // (assuming the `name` property is unique).
                if (column.source && column.source !== (config.dataSource?.source)) {
                    const altSource = DATA_SOURCES[column.source];
                    if (altSource) {
                        const match = altSource.find(x => x.name === item.name);
                        if (match) {
                            item = match;
                        }
                    }
                }

                if (column.render) {
                    return `<td class="p-3 border ${column.align === 'center' ? 'text-center' : ''}">
                        ${column.render(item)}
                    </td>`;
                }

                // If no custom render, display the "field"
                const value = column.field ? item[column.field] : item.name;
                return `<td class="p-3 border ${column.align === 'center' ? 'text-center' : ''}">
                    ${typeof value === 'number' ? formatNumber(value) : (value ?? '')}
                </td>`;
            }

            attachSortHandlers(tableWrapper, type, config) {
                const table = tableWrapper.querySelector('table');
                const headers = table.querySelectorAll('th');
                headers.forEach((header, index) => {
                    header.addEventListener('click', () => {
                        this.handleSort(type, index);
                        this.updateTableBody(tableWrapper, type, config);
                        this.updateSortIndicators(tableWrapper, config, type);
                    });
                });
            }

            handleSort(type, columnIndex) {
                if (!this.sortStates[type]) {
                    this.sortStates[type] = { column: -1, direction: '' };
                }
                const st = this.sortStates[type];
                if (st.column === columnIndex) {
                    if (st.direction === 'desc') {
                        st.direction = 'asc';
                    } else if (st.direction === 'asc') {
                        st.column = -1;
                        st.direction = '';
                    }
                } else {
                    st.column = columnIndex;
                    st.direction = 'desc';
                }
            }

            updateTableBody(tableWrapper, type, config) {
                const table = tableWrapper.querySelector('table');
                const sortState = this.sortStates[type] || { column: -1, direction: '' };
                const filteredData = this.getFilteredData(config, type);
                const sortedData = this.getSortedData(filteredData, config, sortState, table);

                // If we're NOT using domSortSelector for the sorted column, do a normal re-gen of <tbody>
                const columnDef = config.columns[sortState.column];
                if (columnDef && !columnDef.domSortSelector) {
                    table.querySelector('tbody').innerHTML = sortedData
                        .map(item => {
                            const rowCells = config.columns.map(col => this.generateCell(col, item, config));
                            return `<tr class="hover:bg-gray-50">${rowCells.join('')}</tr>`;
                        })
                        .join('');
                }
            }

            updateSortIndicators(tableWrapper, config, type) {
                const sortState = this.sortStates[type] || { column: -1, direction: '' };
                const table = tableWrapper.querySelector('table');
                const headers = table.querySelectorAll('th');
                headers.forEach((header, idx) => {
                    let sortIndicator = '';
                    if (sortState.column === idx) {
                        sortIndicator = sortState.direction === 'asc' ? ' ↑' : ' ↓';
                    }
                    header.innerHTML = `${config.columns[idx].header}${sortIndicator}`;
                });
            }
        }

        // ----------------------------------
        // Instantiate & Populate
        // ----------------------------------
        const tableGen = new TableGenerator();

        function toggleSection(type) {
            const content = document.getElementById(`section-${type.toLowerCase()}-content`);
            const button = document.querySelector(`[data-section="${type}"]`);
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                button.classList.add('collapsed');
            } else {
                content.classList.add('expanded');
                button.classList.remove('collapsed');
            }
        }

        String.prototype.toTitleCase = function() {
            return this.replace(/\w\S*/g, function(txt) {
                return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
            });
        };

        function populateTables() {
            const container = document.getElementById('sections');
            container.innerHTML = '';

            // Collect config keys
            const specialTypes = new Set(Object.keys(TABLE_CONFIGS));
            const sections = new Map();

            // If your items array includes a "type"
            // (like "Equipment-Arrows") we capture that here:
            items.forEach(item => {
                let itemType = item.type?.includes('Equipment-') 
                    ? item.type.split('Equipment-')[1] 
                    : item.type;
                if (itemType) {
                    itemType = itemType.toLowerCase();
                    if (!specialTypes.has(itemType) && !sections.has(itemType)) {
                        sections.set(itemType, {
                            type: itemType,
                            config: TABLE_CONFIGS.default
                        });
                    }
                }
            });

            // Add explicitly configured (arrows, bow, etc.)
            Object.keys(TABLE_CONFIGS).forEach(tKey => {
                if (tKey !== 'default') {
                    sections.set(tKey.toLowerCase(), {
                        type: tKey,
                        config: TABLE_CONFIGS[tKey]
                    });
                }
            });

            const sortedSections = Array.from(sections.values())
                .sort((a, b) => a.type.localeCompare(b.type));

            // Create each section
            sortedSections.forEach(({ type, config }) => {
                const section = document.createElement('div');
                section.className = 'section';
        
                const button = document.createElement('button');
                button.className = 'section-button collapsed';
                button.onclick = () => toggleSection(type);
                button.setAttribute('data-section', type);
                button.textContent = type.toLowerCase() === 'null'
                    ? 'Miscellaneous'
                    : type.toTitleCase();
        
                const content = document.createElement('div');
                content.id = `section-${type.toLowerCase()}-content`;
                content.className = 'section-content';
                
                // Generate table
                const table = tableGen.generateTable(type);
                content.appendChild(table);
        
                section.appendChild(button);
                section.appendChild(content);
                container.appendChild(section);
            });
        }

        // Init on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', populateTables);
    </script>
</body>
</html>